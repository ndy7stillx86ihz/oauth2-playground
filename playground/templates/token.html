{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="columns">
    <div class="column is-10 is-offset-1">
        <!-- Enhanced header with success indicator -->
        <div class="has-text-centered mb-6">
            <h1 class="title">
                <span class="icon is-large has-text-success">
                    <i class="fas fa-check-circle"></i>
                </span>
                Token Information
            </h1>
            <p class="subtitle">OAuth2 flow completed successfully!</p>
        </div>

        {% if access_token %}
        <!-- Improved token display with copy functionality -->
        <div class="card">
            <div class="card-content">
                <div class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <h2 class="subtitle">
                                <span class="icon">
                                    <i class="fas fa-key"></i>
                                </span>
                                Access Token
                            </h2>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <button class="button is-small is-light" onclick="copyToClipboard('{{ access_token }}', this)">
                                <span class="icon is-small">
                                    <i class="fas fa-copy"></i>
                                </span>
                                <span>Copy</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="code-display">{{ access_token }}</div>
            </div>
        </div>

        {% if decoded_token %}
        <div class="card">
            <div class="card-content">
                <h2 class="subtitle">
                    <span class="icon">
                        <i class="fas fa-code"></i>
                    </span>
                    Decoded JWT Token
                </h2>
                <div class="code-display">{{ decoded_token|pprint }}</div>
            </div>
        </div>
        {% endif %}

        {% if refresh_token %}
        <div class="card">
            <div class="card-content">
                <div class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <h2 class="subtitle">
                                <span class="icon">
                                    <i class="fas fa-refresh"></i>
                                </span>
                                Refresh Token
                            </h2>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <button class="button is-small is-light" onclick="copyToClipboard('{{ refresh_token }}', this)">
                                <span class="icon is-small">
                                    <i class="fas fa-copy"></i>
                                </span>
                                <span>Copy</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="code-display">{{ refresh_token }}</div>
            </div>
        </div>
        {% endif %}

        <!-- Enhanced actions section with better visual organization -->
        <div class="card">
            <div class="card-content">
                <h2 class="subtitle">
                    <span class="icon">
                        <i class="fas fa-tools"></i>
                    </span>
                    Actions
                </h2>
                <div class="field is-grouped is-grouped-centered">
                    {% if has_userinfo %}
                    <div class="control">
                        <button class="button is-info is-large" id="get-userinfo-btn">
                            <span class="icon">
                                <i class="fas fa-user"></i>
                            </span>
                            <span>Get UserInfo</span>
                        </button>
                    </div>
                    {% endif %}

                    <div class="control">
                        <a href="{% url 'index' %}" class="button is-primary is-large">
                            <span class="icon">
                                <i class="fas fa-play"></i>
                            </span>
                            <span>New Test</span>
                        </a>
                    </div>

                    <div class="control">
                        <a href="{% url 'logout' %}" class="button is-warning is-large">
                            <span class="icon">
                                <i class="fas fa-sign-out-alt"></i>
                            </span>
                            <span>Clear Session</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Improved userinfo display with better styling -->
        <div id="userinfo-result" class="card" style="display: none;">
            <div class="card-content">
                <h2 class="subtitle">
                    <span class="icon">
                        <i class="fas fa-user-circle"></i>
                    </span>
                    User Information
                </h2>
                <div id="userinfo-content" class="code-display"></div>
            </div>
        </div>

        {% else %}
        <!-- Enhanced no-token state with better guidance -->
        <div class="card">
            <div class="card-content has-text-centered">
                <div class="icon is-large has-text-warning mb-4">
                    <i class="fas fa-exclamation-triangle fa-3x"></i>
                </div>
                <div class="notification is-warning">
                    <p><strong>No token information available.</strong></p>
                    <p>Please complete the OAuth2 flow first to see token details.</p>
                </div>
                <a href="{% url 'index' %}" class="button is-primary is-large">
                    <span class="icon">
                        <i class="fas fa-arrow-left"></i>
                    </span>
                    <span>Back to Playground</span>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Enhanced JavaScript with copy functionality and better UX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const getUserInfoBtn = document.getElementById('get-userinfo-btn');
    const userinfoResult = document.getElementById('userinfo-result');
    const userinfoContent = document.getElementById('userinfo-content');

    if (getUserInfoBtn) {
        getUserInfoBtn.addEventListener('click', async function() {
            setButtonLoading(this, true);

            try {
                const response = await fetch('{% url "get_userinfo" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    userinfoContent.textContent = JSON.stringify(data.userinfo, null, 2);
                    userinfoResult.style.display = 'block';
                    scrollToElement(userinfoResult);
                    showSuccess('User information loaded successfully!');
                } else {
                    userinfoContent.textContent = 'Error: ' + (data.error || 'Failed to fetch userinfo');
                    userinfoResult.style.display = 'block';
                    showError(data.error || 'Failed to fetch user information');
                }
            } catch (error) {
                userinfoContent.textContent = 'Network error: ' + error.message;
                userinfoResult.style.display = 'block';
                showError('Network error: ' + error.message);
            } finally {
                setButtonLoading(this, false);
            }
        });
    }

    function setButtonLoading(button, loading) {
        if (loading) {
            button.classList.add('is-loading');
            button.disabled = true;
        } else {
            button.classList.remove('is-loading');
            button.disabled = false;
        }
    }

    function scrollToElement(element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});

// Copy to clipboard functionality
function copyToClipboard(text, button) {
    navigator.clipboard.writeText(text).then(function() {
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="icon is-small"><i class="fas fa-check"></i></span><span>Copied!</span>';
        button.classList.add('is-success');

        setTimeout(function() {
            button.innerHTML = originalText;
            button.classList.remove('is-success');
        }, 2000);
    }).catch(function(err) {
        showError('Failed to copy to clipboard');
    });
}
</script>
{% endblock %}
